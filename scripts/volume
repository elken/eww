#!/usr/bin/env bb
(require '[babashka.process :refer [shell]])

(defn cmd [cmd]
  (->> cmd
       (shell {:out :string})
       :out
       str/split-lines
       first))

(defn sink-status []
  (cmd "wpctl get-volume @DEFAULT_AUDIO_SINK@"))

(defn source-status []
  (cmd "wpctl get-volume @DEFAULT_AUDIO_SOURCE@"))

(defn status->volume [status]
  (-> status
      (str/split #" ")
      last
      parse-double
      (* 100)
      int))

(try
  (let [source (first *command-line-args*)
        volume (-> *command-line-args* second parse-long)]
    (when (and source volume)
      (println
       (format
        "wpctl set-volume -l 1.0 %s %f"
        source
        (/ volume 100.0)))
      (shell
       (format
        "wpctl set-volume -l 1.0 %s %f "
        source
        (/ volume 100.0)))))
  (catch Exception _))

(->> {:sink (status->volume (sink-status))
      :source (status->volume (source-status))}
     json/generate-string
     println)
