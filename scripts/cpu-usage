#!/usr/bin/env bb
(require '[babashka.process :refer [shell]])

(defn cpu-lines []
  (-> "cat /proc/stat"
      (shell {:out :string})
      :out
      str/split-lines))

(->> (cpu-lines)
     (filter #(str/starts-with? % "cpu"))
     (reduce
      (fn [acc cpu]
        (let [[_ & values] (str/split cpu #"\s+")
              values (map parse-long values)]
          (conj
           acc
           (->>
            values
            (apply +)
            (/ (* 100.0 (nth values 3)))
            (- 100)
            int))))
      [])
     json/generate-string
     println)
